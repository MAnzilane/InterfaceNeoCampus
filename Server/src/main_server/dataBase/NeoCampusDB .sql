-- PARENT TABLES
CREATE TABLE IF NOT EXISTS INITIALIZED
	(INIT INT,
	 CONSTRAINT pk_init PRIMARY KEY (INIT)
);

INSERT INTO INITIALIZED VALUES (0);

CREATE TABLE IF NOT EXISTS PERSON
	(idPerson INT AUTO_INCREMENT,
	 userName CHAR(8),
	 lastName VARCHAR(16),
	 firstName VARCHAR(16),
	 salt CHAR(32),
	 hashValue CHAR(32),
	 type ENUM ('CAMPUS', 'SERVICE'),
	 CONSTRAINT pk_user PRIMARY KEY (idPerson),
	 CONSTRAINT ck_last CHECK (lastName IS NOT NULL),
	 CONSTRAINT ck_first CHECK (firstName IS NOT NULL),
	 UNIQUE KEY ix_person (lastName, firstName, type)
);

CREATE TABLE IF NOT EXISTS GROUPE
	(nameGrp VARCHAR(64),
	 type ENUM ('CAMPUS', 'SERVICE'),
	 CONSTRAINT pk_grp PRIMARY KEY (nameGrp),
	 UNIQUE KEY ix_grp (nameGrp)
);

-- CHILD TABLES
CREATE TABLE IF NOT EXISTS TICKET
	(idTicket INT AUTO_INCREMENT,
	 title VARCHAR(128),
	 nameGrp VARCHAR(64),
	 idPerson INT,
	 creationDate DATETIME,
	 CONSTRAINT pk_ticket PRIMARY KEY (idTicket),
	 CONSTRAINT ck_title CHECK (title IS NOT NULL),
	 CONSTRAINT ck_date CHECK (creationDate IS NOT NULL),
	 CONSTRAINT fk_ticket_grp FOREIGN KEY (nameGrp) REFERENCES GROUPE (nameGrp),
	 CONSTRAINT	fk_ticket_pers FOREIGN KEY (idPerson) REFERENCES PERSON (idPerson)
);

CREATE TABLE IF NOT EXISTS MESSAGE
	(idMsg INT AUTO_INCREMENT,
	 msgText TEXT,
	 color ENUM ('RED', 'ORANGE', 'GREEN'),
	 idTicket INT, 
	 idPerson INT,
	 writeDate DATETIME,
	 CONSTRAINT pk_msg PRIMARY KEY (idMsg),
	 CONSTRAINT ck_msg_ticket CHECK (idTicket IS NOT NULL),
	 CONSTRAINT ck_msg_pers CHECK (idPerson IS NOT NULL),
	 CONSTRAINT fk_msg_ticket FOREIGN KEY (idTicket) REFERENCES TICKET (idTicket), 
	 CONSTRAINT fk_msg_pers FOREIGN KEY (idPerson) REFERENCES PERSON (idPerson)
);

CREATE TABLE IF NOT EXISTS MEMBER_OF
	(idPerson INT,
	 nameGrp VARCHAR(64),
	 CONSTRAINT ck_member_of_grp CHECK (nameGrp IS NOT NULL),
	 CONSTRAINT ck_member_of_pers CHECK (nameGrp IS NOT NULL),
	 CONSTRAINT fk_member_of_grp FOREIGN KEY (nameGrp) REFERENCES GROUPE (nameGrp),
	 CONSTRAINT fk_member_of_pers FOREIGN KEY (idPerson) REFERENCES PERSON (idPerson),
	 CONSTRAINT pk_member_of PRIMARY KEY(nameGrp, idPerson),
     CONSTRAINT ck_type CHECK (type IS NOT NULL)
);

CREATE TABLE IF NOT EXISTS RECEIVE
	(idPerson INT,
	 idMsg INT,
	 status ENUM ('RECU', 'LU'),
	 CONSTRAINT ck_rcv_pers CHECK (idPerson IS NOT NULL),
	 CONSTRAINT ck_rcv_msg CHECK (idMsg IS NOT NULL),
	 CONSTRAINT fk_rcv_pers FOREIGN KEY (idPerson) REFERENCES PERSON (idPerson),
	 CONSTRAINT fk_rcv_msg FOREIGN KEY (idMsg) REFERENCES MESSAGE (idMsg),
	 CONSTRAINT pk_rcv PRIMARY KEY(idPerson, idMsg)
);

ALTER TABLE PERSON AUTO_INCREMENT=1000;
ALTER TABLE MESSAGE AUTO_INCREMENT=1;
ALTER TABLE TICKET AUTO_INCREMENT=1;

INSERT IGNORE INTO PERSON (lastName, firstName, type) VALUES ("Barriol", "Luc", 'CAMPUS');
INSERT IGNORE INTO PERSON (lastName, firstName, type) VALUES ("Begg", "Alexandra", 'CAMPUS');
INSERT IGNORE INTO PERSON (lastName, firstName, type) VALUES ("Cabantos", "Claire", 'CAMPUS');
INSERT IGNORE INTO PERSON (lastName, firstName, type) VALUES ("Veillith", "Michel", 'CAMPUS');
INSERT IGNORE INTO PERSON (lastName, firstName, type) VALUES ("Vernier", "Florence", 'SERVICE');
INSERT IGNORE INTO PERSON (lastName, firstName, type) VALUES ("Walbaum", "Ghislaine", 'CAMPUS');
INSERT IGNORE INTO PERSON (lastName, firstName, type) VALUES ("Walbaum", "Laurence", 'CAMPUS');
INSERT IGNORE INTO PERSON (lastName, firstName, type) VALUES ("Ziffer", "Elizabeth", 'SERVICE');
INSERT IGNORE INTO PERSON (lastName, firstName, type) VALUES ("Arroui", "Sid", 'CAMPUS');
INSERT IGNORE INTO PERSON (lastName, firstName, type) VALUES ("Mmadi", "Anzilane", 'SERVICE');
INSERT IGNORE INTO PERSON (lastName, firstName, type) VALUES ("Perrnot", "Patricia", 'SERVICE');
INSERT IGNORE INTO PERSON (lastName, firstName, type) VALUES ("Poirier", "Francois", 'CAMPUS');
INSERT IGNORE INTO PERSON (lastName, firstName, type) VALUES ("Samson", "Christine", 'CAMPUS');
INSERT IGNORE INTO PERSON (lastName, firstName, type) VALUES ("Sciandra", "Philippe", 'SERVICE');
INSERT IGNORE INTO PERSON (lastName, firstName, type) VALUES ("Snethlage", "Michel", 'SERVICE');
INSERT IGNORE INTO PERSON (lastName, firstName, type) VALUES ("Teyssier", "Agnes", 'SERVICE');
INSERT IGNORE INTO PERSON (lastName, firstName, type) VALUES ("Vernier", "Elisabeth", 'CAMPUS');
INSERT IGNORE INTO PERSON (lastName, firstName, type) VALUES ("Armand", "Michael", 'CAMPUS');
INSERT IGNORE INTO PERSON (lastName, firstName, type) VALUES ("Astier", "Nicole", 'CAMPUS');
INSERT IGNORE INTO PERSON (lastName, firstName, type) VALUES ("Brunier", "Gilles", 'SERVICE');


INSERT IGNORE INTO GROUPE VALUES ("INFORMATIQUE", 'CAMPUS');
INSERT IGNORE INTO GROUPE VALUES ("MECHANIQUE", 'CAMPUS');
INSERT IGNORE INTO GROUPE VALUES ("BIOLOGIE", 'CAMPUS');
INSERT IGNORE INTO GROUPE VALUES ("STAPS", 'CAMPUS');
INSERT IGNORE INTO GROUPE VALUES ("TENNIS", 'CAMPUS');
INSERT IGNORE INTO GROUPE VALUES ("FOOTBALL", 'CAMPUS');
INSERT IGNORE INTO GROUPE VALUES ("NATATION", 'CAMPUS');
INSERT IGNORE INTO GROUPE VALUES ("GROUPE 1", 'CAMPUS');
INSERT IGNORE INTO GROUPE VALUES ("GROUPE 2", 'CAMPUS');
INSERT IGNORE INTO GROUPE VALUES ("GROUPE 3", 'CAMPUS');
INSERT IGNORE INTO GROUPE VALUES ("GROUPE 4", 'CAMPUS');
INSERT IGNORE INTO GROUPE VALUES ("GESTION DES EDT", 'SERVICE');
INSERT IGNORE INTO GROUPE VALUES ("SERVICES TECHNIQUES", 'SERVICE');
INSERT IGNORE INTO GROUPE VALUES ("GESTION DE L'ENTRETIEN DES SALLES", 'SERVICE');

INSERT IGNORE INTO MEMBER_OF VALUES (1000, "MECHANIQUE");
INSERT IGNORE INTO MEMBER_OF VALUES (1000, "GROUPE 2");
INSERT IGNORE INTO MEMBER_OF VALUES (1001, "INFORMATIQUE");
INSERT IGNORE INTO MEMBER_OF VALUES (1001, "TENNIS");
INSERT IGNORE INTO MEMBER_OF VALUES (1001, "GROUPE 1");
INSERT IGNORE INTO MEMBER_OF VALUES (1002, "BIOLOGIE");
INSERT IGNORE INTO MEMBER_OF VALUES (1002, "GROUPE 3");
INSERT IGNORE INTO MEMBER_OF VALUES (1003, "STAPS");
INSERT IGNORE INTO MEMBER_OF VALUES (1004, "GESTION DES EDT");
INSERT IGNORE INTO MEMBER_OF VALUES (1005, "MECHANIQUE");
INSERT IGNORE INTO MEMBER_OF VALUES (1005, "NATATION");
INSERT IGNORE INTO MEMBER_OF VALUES (1006, "MECHANIQUE");
INSERT IGNORE INTO MEMBER_OF VALUES (1006, "FOOTBALL");
INSERT IGNORE INTO MEMBER_OF VALUES (1006, "GROUPE 2");
INSERT IGNORE INTO MEMBER_OF VALUES (1007, "SERVICES TECHNIQUES");
INSERT IGNORE INTO MEMBER_OF VALUES (1008, "INFORMATIQUE");
INSERT IGNORE INTO MEMBER_OF VALUES (1008, "GROUPE 1");
INSERT IGNORE INTO MEMBER_OF VALUES (1008, "NATATION");
INSERT IGNORE INTO MEMBER_OF VALUES (1009, "SERVICES TECHNIQUES");
INSERT IGNORE INTO MEMBER_OF VALUES (1010, "GESTION DE L'ENTRETIEN DES SALLES");
INSERT IGNORE INTO MEMBER_OF VALUES (1011, "STAPS");
INSERT IGNORE INTO MEMBER_OF VALUES (1011, "NATATION");
INSERT IGNORE INTO MEMBER_OF VALUES (1012, "BIOLOGIE");
INSERT IGNORE INTO MEMBER_OF VALUES (1012, "MECHANIQUE");
INSERT IGNORE INTO MEMBER_OF VALUES (1012, "INFORMATIQUE");
INSERT IGNORE INTO MEMBER_OF VALUES (1013, "GESTION DES EDT");
INSERT IGNORE INTO MEMBER_OF VALUES (1014, "GESTION DES EDT");
INSERT IGNORE INTO MEMBER_OF VALUES (1015, "SERVICES TECHNIQUES");
INSERT IGNORE INTO MEMBER_OF VALUES (1016, "INFORMATIQUE");
INSERT IGNORE INTO MEMBER_OF VALUES (1016, "TENNIS");
INSERT IGNORE INTO MEMBER_OF VALUES (1016, "GROUPE 3");
INSERT IGNORE INTO MEMBER_OF VALUES (1017, "STAPS");
INSERT IGNORE INTO MEMBER_OF VALUES (1017, "TENNIS");
INSERT IGNORE INTO MEMBER_OF VALUES (1017, "FOOTBALL");
INSERT IGNORE INTO MEMBER_OF VALUES (1017, "NATATION");
INSERT IGNORE INTO MEMBER_OF VALUES (1018, "GROUPE 2");
INSERT IGNORE INTO MEMBER_OF VALUES (1019, "GESTION DE L'ENTRETIEN DES SALLES");

INSERT INTO `TICKET` (`idTicket`, `title`, `nameGrp`, `idPerson`, `creationDate`) VALUES
(1,	'HELLO!',	'GESTION DES EDT',	1001,	'2017-10-29 14:00:00'),
(2,	'GOODBYE!',	'INFORMATIQUE',	1004,	'2017-10-30 15:12:54'),
(3,	'PROBLEME!',	'INFORMATIQUE',	1007,	'2017-10-29 10:00:02');

INSERT INTO `MESSAGE` (`idMsg`, `msgText`, `color`, `idTicket`, `idPerson`, `writeDate`) VALUES
(1,	'Goodbye everyone!',	'RED',	2,	1004,	'2017-10-30 15:12:54'),
(2,	'Hi everyone',	'RED',	1,	1001,	'2017-10-29 14:00:00'),
(3,	'Hello to you!',	'RED',	1,	1004,	'2017-10-29 14:52:00'),
(4,	'Il y a un probleme!',	'RED',	3,	1007,	'2017-10-29 10:00:02'),
(5,	'C\'est quoi le probleme?! Vous aviez pas dit!',	'RED',	3,	1001,	'2017-10-29 11:09:02'),
(6,	'C\'est surement nadege qui a foutu la merde...',	'RED',	3,	1012,	'2017-10-29 13:00:02');

INSERT INTO `RECEIVE` (`idPerson`, `idMsg`, `status`) VALUES
(1001,	1,	'LU'),
(1008,	1,	'RECU'),
(1012,	1,	'RECU'),
(1016,	1,	'LU'),
(1001,	4,	'LU'),
(1008,	4,	'LU'),
(1012,	4,	'LU'),
(1016,	4,	'LU'),
(1001,	5,	'LU'),
(1008,	5,	'RECU'),
(1012,	5,	'LU'),
(1016,	5,	'RECU'),
(1001,	6,	'RECU'),
(1008,	6,	'RECU'),
(1012,	6,	'RECU'),
(1016,	6,	'RECU'),
(1004,	2,	'LU'),
(1013,	2,	'LU'),
(1014,	2,	'RECU'),
(1016,	2,	'LU'),
(1004,	3,	'RECU'),
(1013,	3,	'LU'),
(1014,	3,	'RECU'),
(1016,	3,	'LU');